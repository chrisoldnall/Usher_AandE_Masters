```{r LoadingPackages}
# List of packages
packages <- c(
  "tidyverse", "here", "readxl", 
  "lubridate", "sf", "scales", "sjPlot",
  "ggrepel"
)

# Load packages
lapply(packages, library, character.only = TRUE)
```

```{r ShapeFile}
# Path to the shapefile
shapefile_path <- here("data/AdaptedData", "SG_NHS_HealthBoards_2019", "SG_NHS_HealthBoards_2019.shp")

# Read the shapefile
scottish_health_boards <- st_read(shapefile_path)

# Create centroids for labels
labels_data <- scottish_health_boards %>%
  mutate(geometry = st_centroid(geometry))
```

```{r DataImport}
# Import the dataset from the specified path
data <- read_csv(here("data/ProcessedData", "AE_Pop_Merged_Per1000_Summary.csv"))

health_board_acronyms <- c(
  "Ayrshire and Arran" = "Ayrshire\nand\nArran",
  "Borders" = "Borders",
  "Dumfries and Galloway" = "Dumfries and\nGalloway",
  "Forth Valley" = "Forth Valley",
  "Fife" = "Fife",
  "Grampian" = "Grampian",
  "Greater Glasgow and Clyde" = "Greater\nGlasgow\nand Clyde",
  "Highland" = "Highland",
  "Lanarkshire" = "Lanarkshire",
  "Lothian" = "Lothian",
  "Orkney" = "Orkney",
  "Shetland" = "Shetland",
  "Tayside" = "Tayside",
  "Western Isles" = "Western Isles"
)
```

```{r CholoroplethFunction}
create_choropleth_scenario <- function(shape_data, data, year, scenario = c("attendance", "waiting_time"), title = NULL, output_path = NULL) {
  scenario <- match.arg(scenario)
  
  # Ensure output path ends with .svg
  if (!is.null(output_path)) {
    if (!grepl("\\.svg$", output_path)) {
      output_path <- paste0(output_path, ".svg")
    }
  }
  
  # Step 1: Filter the relevant data based on the scenario
  if (scenario == "attendance") {
    filtered_data <- data %>%
      filter(Year == year) %>%
      select(HBName, attendanceper1000pop) %>%
      mutate(attendanceper1000pop = round(attendanceper1000pop, 1)) %>%
      mutate(HBName = str_replace(HBName, "NHS ", ""))  # Remove "NHS " prefix
  } else if (scenario == "waiting_time") {
    filtered_data <- data %>%
      filter(Year == year) %>%
      select(HBName, PercentageWithin4HoursAll) %>%
      mutate(PercentageWithin4HoursAll = round(PercentageWithin4HoursAll, 1)) %>%
      mutate(HBName = str_replace(HBName, "NHS ", ""))  # Remove "NHS " prefix
  }
  
  # Step 2: Add the HBAbbreviation column
  filtered_data <- filtered_data %>%
    mutate(HBAbbreviation = sapply(HBName, function(x) {
      if (x %in% names(health_board_acronyms)) {
        return(health_board_acronyms[[x]])
      } else {
        return(x)  # Use full name if no acronym is found
      }
    }))
  
  # Step 3: Merge the shapefile with the filtered data
  merged_data <- shape_data %>%
    left_join(filtered_data, by = "HBName")
  
  # Step 4: Create the base plot
  p <- ggplot(merged_data) +
    geom_sf(aes(fill = if (scenario == "attendance") attendanceper1000pop else PercentageWithin4HoursAll)) +
    theme_void()

  # Step 5: Conditionally add the appropriate color scale
  if (scenario == "attendance") {
    p <- p + scale_fill_gradientn(
      colors = c("green", "yellow", "red"),
      values = scales::rescale(c(0, 20, 35)),  # Fixed range for attendance
      name = "Attendance per 1000 Population",
      limits = c(0, 35),  # Fixed range
      breaks = seq(0, 35, 10)  # Breaks at every 5 units
    )
  } else if (scenario == "waiting_time") {
    p <- p + scale_fill_gradientn(
      colors = c("green", "yellow", "red"),
      values = scales::rescale(c(60, 95, 100)),  # Emphasize the range below 95%, but include 0-100%
      name = "Percentage Seen Within 4 Hours",
      limits = c(0, 100),  # Show the entire 0-100% range
      breaks = seq(0, 100, 20),  # Add breaks every 10% for clarity
      labels = function(x) paste0(x, "%")  # Add % symbol to labels
    )
  }

  # Step 5: Add the title
  if (is.null(title)) {
    # Default title if not provided
    title <- if (scenario == "attendance") {
      paste("A&E Attendance Rate per 1000 Population in", year)
    } else {
      paste("Percentage Seen Within 4 Hours in", year)
    }
  }
  # Add the title to the plot and increase title size
  p <- p + labs(title = title) +
    theme(plot.title = element_text(size = 64, face = "bold", hjust = 0.5))  # Adjust title size
  # Step 6: Add general labels for most health boards, excluding Orkney, Fife, and Shetland
  p <- p + 
    geom_sf_label(data = merged_data %>% filter(!HBName %in% c("Orkney", "Fife", "Shetland", "Greater Glasgow and Clyde", "Ayrshire and Arran", "Borders")), aes(label = HBAbbreviation), size = 8, label.size = 1, fill = "white", alpha = 0.7) +
  
    # Fine-tune the label positions for Orkney, Fife, and Shetland
    #geom_sf_label(data = merged_data %>% filter(HBName == "Greater Glasgow and Clyde"), aes(label = HBAbbreviation), 
    #              nudge_x = 2000, size = 8, label.size = 1, fill = "white", alpha = 0.7) +  # Nudge Orkney label upwards more
    geom_sf_label(data = merged_data %>% filter(HBName == "Orkney"), aes(label = HBAbbreviation), 
                  nudge_y = 3000, size = 8, label.size = 1, fill = "white", alpha = 0.7) +  # Nudge Orkney label upwards more
    geom_sf_label(data = merged_data %>% filter(HBName == "Fife"), aes(label = HBAbbreviation), 
                  nudge_y = 7000, size = 8, label.size = 1, fill = "white", alpha = 0.7) +  # Nudge Fife label upwards more
    geom_sf_label(data = merged_data %>% filter(HBName == "Shetland"), aes(label = HBAbbreviation), 
                  nudge_y = -5000, nudge_x = -10000, size = 8, label.size = 1, fill = "white", alpha = 0.7) +  # Nudge Shetland label down and to the left
    geom_sf_label(data = merged_data %>% filter(HBName == "Borders"), aes(label = HBAbbreviation), 
                nudge_y = -5000, nudge_x = 10000, size = 8, label.size = 1, fill = "white", alpha = 0.7)  # Nudge Border label down and to the right
    #geom_sf_label(data = merged_data %>% filter(HBName == "Ayrshire and Arran"), aes(label = HBAbbreviation), 
    #              nudge_y = -2000, nudge_x = -5000, size = 8, label.size = 1, fill = "white", alpha = 0.7)  # Nudge Shetland label down and to the left
  
  # Step 7: Save the plot as an SVG file
  # If an output path is provided, save the plot, otherwise return it
  if (!is.null(output_path)) {
    ggsave(output_path, plot = p, width = 16, height = 18, device = "svg")
    print(paste("Choropleth saved as", output_path))
    return(output_path)  # Return the file path
  } else {
    return(p)  # Return the plot object if no output path
  }
}
```

```{r GenerateChloropleths}
# Generate attendance rate choropleth for 2022
create_choropleth_scenario(
  shape_data = scottish_health_boards,
  data = data,
  year = 2022,
  scenario = "attendance",
  title = "Custom Title for A&E Attendance in 2018",
  output_path = "coldnall/results/COVID_Choloropleths/CovidScottishAttendanceRate2022.svg"
)

# Generate waiting time choropleth for 2022
create_choropleth_scenario(
  shape_data = scottish_health_boards,
  data = data,
  year = 2022,
  scenario = "waiting_time",
  output_path = "coldnall/results/COVID_Choloropleths/CovidScottish4Hour2022.svg"
)

# Generate attendance rate choropleth for 2020
create_choropleth_scenario(
  shape_data = scottish_health_boards,
  data = data,
  year = 2020,
  scenario = "attendance",
  output_path = "coldnall/results/COVID_Choloropleths/CovidScottishAttendanceRate2020.svg"
)

# Generate waiting time choropleth for 2020
create_choropleth_scenario(
  shape_data = scottish_health_boards,
  data = data,
  year = 2020,
  scenario = "waiting_time",
  output_path = "coldnall/results/COVID_Choloropleths/CovidScottish4Hour2020.svg"
)

# Generate attendance rate choropleth for 2018
create_choropleth_scenario(
  shape_data = scottish_health_boards,
  data = data,
  year = 2018,
  scenario = "attendance",
  output_path = "coldnall/results/COVID_Choloropleths/CovidScottishAttendanceRate2018.svg"
)

# Generate waiting time choropleth for 2018
create_choropleth_scenario(
  shape_data = scottish_health_boards,
  data = data,
  year = 2018,
  scenario = "waiting_time",
  output_path = "coldnall/results/COVID_Choloropleths/CovidScottish4Hour2018.svg"
)
```

```{r CholoroplethGrid}
# Install the necessary package for combining plots if you don't have it
# install.packages("patchwork")

library(patchwork)  # For combining plots

# Function to generate and return plots without saving
create_plot_for_year <- function(shape_data, data, year, scenario, title) {
  p <- create_choropleth_scenario(
    shape_data = shape_data,
    data = data,
    year = year,
    scenario = scenario,
    title = title
  ) +
  theme(
    legend.key.size = unit(4, 'cm'),         # Increase legend key size
    legend.text = element_text(size = 48),   # Increase legend text size
    legend.title = element_text(size = 48)   # Increase legend title size
  )
  return(p)
}

# Generate the plots for each year and scenario
attendance_2018 <- create_plot_for_year(scottish_health_boards, data, 2018, "attendance", title="A")
attendance_2020 <- create_plot_for_year(scottish_health_boards, data, 2020, "attendance", title="B")
attendance_2022 <- create_plot_for_year(scottish_health_boards, data, 2022, "attendance", title="C")

waiting_time_2018 <- create_plot_for_year(scottish_health_boards, data, 2018, "waiting_time", title="D")
waiting_time_2020 <- create_plot_for_year(scottish_health_boards, data, 2020, "waiting_time", title="E")
waiting_time_2022 <- create_plot_for_year(scottish_health_boards, data, 2022, "waiting_time", title="F")

# Combine the plots into a 3x2 grid and collect the legend
grid_plot <- (attendance_2018 | attendance_2020 | attendance_2022) /
             (waiting_time_2018 | waiting_time_2020 | waiting_time_2022) +
             plot_layout(guides = "collect") &
             theme(
               legend.position = "right",  # Adjust legend position ("bottom", "top", "left", or "right")
               legend.key.size = unit(4, 'cm'),  # Increase legend key size
               legend.text = element_text(size = 48),  # Increase legend text size
               legend.title = element_text(size = 48)  # Increase legend title size
             )


# Display the combined grid
print(grid_plot)

# Save the grid as an SVG or PNG file with increased width and height to avoid squishing
ggsave("/Users/chrisoldnall/Library/Mobile Documents/com~apple~CloudDocs/PhD/Masters Supervision/1. Hui Pheng Teoh/GitHub/Usher_AandE_Masters/Usher_AandE_Masters/coldnall/results/COVID_Choloropleths/CovidScottish_WaitingAttendance_2018_2020_2022.svg", plot = grid_plot, width = 45, height = 30, device = "svg")
ggsave("/Users/chrisoldnall/Library/Mobile Documents/com~apple~CloudDocs/PhD/Masters Supervision/1. Hui Pheng Teoh/GitHub/Usher_AandE_Masters/Usher_AandE_Masters/coldnall/results/COVID_Choloropleths/CovidScottish_WaitingAttendance_2018_2020_2022.png", plot = grid_plot, width = 45, height = 30, device = "png")
```